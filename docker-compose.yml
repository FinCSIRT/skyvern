version: '3.8'

services:
  # 1. VPN SERVICE (Named 'skyvern-vpn')
  skyvern-vpn:
    image: qmcgaw/gluetun
    container_name: skyvern-vpn
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - VPN_SERVICE_PROVIDER=${VPN_PROVIDER}
      - VPN_TYPE=${VPN_TYPE}
      - SERVER_COUNTRIES=${VPN_COUNTRY}
      - OPENVPN_USER=${VPN_USER}
      - OPENVPN_PASSWORD=${VPN_PASSWORD}
      - TZ=${TIMEZONE}
      - FIREWALL_OUTBOUND_SUBNETS=172.16.0.0/12,192.168.0.0/16,10.0.0.0/8
    ports:
      - 8889:8888/tcp
    networks:
      - dokploy-network
    restart: always
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.skyvern-api.rule=Host(`${SKYVERN_API_DOMAIN}`)"
      - "traefik.http.routers.skyvern-api.entrypoints=websecure"
      - "traefik.http.routers.skyvern-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.skyvern-api.loadbalancer.server.port=8000"
      - "traefik.http.routers.skyvern-api.middlewares=skyvern-cors"
      - "traefik.http.middlewares.skyvern-cors.headers.accesscontrolallowmethods=GET,POST,PUT,DELETE,OPTIONS"
      - "traefik.http.middlewares.skyvern-cors.headers.accesscontrolalloworiginlist=https://${SKYVERN_UI_DOMAIN}"
      - "traefik.http.middlewares.skyvern-cors.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.skyvern-cors.headers.addvaryheader=true"

  postgres:
    image: postgres:14-alpine
    restart: always
    volumes:
      - ./postgres-data:/var/lib/postgresql/data
    environment:
      - PGDATA=/var/lib/postgresql/data/pgdata
      - POSTGRES_USER=skyvern
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=skyvern
    networks:
      - dokploy-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U skyvern"]
      interval: 5s
      timeout: 5s
      retries: 5

  skyvern:
    image: public.ecr.aws/skyvern/skyvern:latest
    restart: on-failure
    
    # ✅ FIX: Pointing to the new name 'skyvern-vpn'
    network_mode: "service:skyvern-vpn"

    volumes:
      - ./artifacts:/data/artifacts
      - ./videos:/data/videos
      - ./har:/data/har
      - ./log:/data/log
      - ./.streamlit:/app/.streamlit
    environment:
      - DATABASE_STRING=postgresql+psycopg://skyvern:${POSTGRES_PASSWORD}@postgres:5432/skyvern
      - BROWSER_TYPE=chromium-headful
      - ENABLE_CODE_BLOCK=true
      - ENABLE_OPENAI=${ENABLE_OPENAI}
      - LLM_KEY=OPENAI_GPT4O
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ENABLE_ANTHROPIC=${ENABLE_ANTHROPIC}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ENABLE_OLLAMA=${ENABLE_OLLAMA}
      - LLM_KEY=${LLM_KEY} 
      - OLLAMA_MODEL=${OLLAMA_MODEL}
      - OLLAMA_SERVER_URL=${OLLAMA_SERVER_URL}
      - OLLAMA_SUPPORTS_VISION=${OLLAMA_SUPPORTS_VISION}
    
    # ✅ FIX: Merged both dependencies into ONE block
    depends_on:
      postgres:
        condition: service_healthy
      skyvern-vpn:
        condition: service_started
        
    healthcheck:
      test: ["CMD", "test", "-f", "/app/.streamlit/secrets.toml"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  skyvern-ui:
    image: public.ecr.aws/skyvern/skyvern-ui:latest
    restart: on-failure
    volumes:
      - ./artifacts:/data/artifacts
      - ./videos:/data/videos
      - ./har:/data/har
      - ./.streamlit:/app/.streamlit
    environment:
      - VITE_WSS_BASE_URL=wss://${SKYVERN_API_DOMAIN}/api/v1
      - VITE_API_BASE_URL=https://${SKYVERN_API_DOMAIN}/api/v1
    depends_on:
      skyvern:
        condition: service_started
    networks:
      - dokploy-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.skyvern-ui.rule=Host(`${SKYVERN_UI_DOMAIN}`)"
      - "traefik.http.routers.skyvern-ui.entrypoints=websecure"
      - "traefik.http.routers.skyvern-ui.tls.certresolver=letsencrypt"
      - "traefik.http.services.skyvern-ui.loadbalancer.server.port=8080"

networks:
  dokploy-network:
    external: true
